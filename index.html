<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giviso Water Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;700;900&display=swap" rel="stylesheet">
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, deleteDoc, updateDoc, doc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "YOUR_API_KEY", // Dán mã của bạn vào đây
            projectId: "YOUR_PROJECT_ID"
        };
        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.fs = { collection, onSnapshot, addDoc, deleteDoc, updateDoc, doc, query, orderBy, serverTimestamp };
    </script>
    <style>
        body { font-family: 'Lexend', sans-serif; background-color: #f0f2f5; }
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 20px; height: calc(100vh - 40px); }
        .bento-box { @apply rounded-[3rem] p-10 shadow-sm border border-white/50 flex flex-col overflow-hidden transition-transform hover:scale-[1.01]; }
        .huge-title { @apply text-5xl font-black tracking-tighter mb-8 uppercase italic; }
        .input-field { @apply bg-white/60 border-none rounded-2xl px-5 py-4 mb-3 w-full font-bold text-lg focus:ring-4 focus:ring-white outline-none; }
        .btn-action { @apply bg-white/80 text-zinc-900 px-8 py-4 rounded-2xl font-black text-lg uppercase shadow-sm hover:bg-white transition-all active:scale-95; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { @apply bg-black/10 rounded-full; }
    </style>
</head>
<body class="p-5">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const App = () => {
            const [customers, setCustomers] = useState([]);
            const [deliveries, setDeliveries] = useState([]);
            const [search, setSearch] = useState("");
            const [newCust, setNewCust] = useState({ name: '', phone: '', address: '' });

            useEffect(() => {
                const { collection, onSnapshot, query, orderBy } = window.fs;
                onSnapshot(query(collection(window.db, "customers"), orderBy("name")), (sn) => 
                    setCustomers(sn.docs.map(d => ({id: d.id, ...d.data()}))));
                onSnapshot(query(collection(window.db, "deliveries"), orderBy("timestamp", "desc")), (sn) => 
                    setDeliveries(sn.docs.map(d => ({id: d.id, ...d.data()}))));
            }, []);

            const addCustomer = async () => {
                if(!newCust.name) return;
                await window.fs.addDoc(window.fs.collection(window.db, "customers"), newCust);
                setNewCust({ name: '', phone: '', address: '' });
            };

            const markAsCollected = async (id) => {
                await window.fs.updateDoc(window.fs.doc(window.db, "deliveries", id), { collected: true });
            };

            const deleteItem = async (col, id) => {
                if(confirm("Bạn có chắc chắn muốn xóa?")) await window.fs.deleteDoc(window.fs.doc(window.db, col, id));
            };

            const totalDebtShells = deliveries.reduce((s, d) => s + (!d.collected ? (Number(d.quantity) || 0) : 0), 0);
            const totalDebtCash = totalDebtShells * 50000;

            return (
                <div className="grid-container">
                    
                    {/* 1. QUẢN LÝ KHÁCH HÀNG (Xanh Mint Nhạt) */}
                    <div className="bento-box bg-[#e2f3ed]">
                        <h2 className="huge-title text-[#2d6a4f]">Khách Hàng</h2>
                        <div className="bg-white/40 p-6 rounded-[2rem] mb-6 border border-white">
                            <input className="input-field" placeholder="HỌ TÊN KHÁCH" value={newCust.name} onChange={e => setNewCust({...newCust, name: e.target.value})} />
                            <div className="flex gap-3">
                                <input className="input-field" placeholder="SĐT" value={newCust.phone} onChange={e => setNewCust({...newCust, phone: e.target.value})} />
                                <input className="input-field" placeholder="ĐỊA CHỈ" value={newCust.address} onChange={e => setNewCust({...newCust, address: e.target.value})} />
                            </div>
                            <button onClick={addCustomer} className="btn-action w-full mt-2">Thêm Khách Mới +</button>
                        </div>
                        <div className="flex-1 overflow-auto space-y-4 pr-2">
                            {customers.map((c, i) => (
                                <div key={c.id} className="flex justify-between items-center p-6 bg-white rounded-3xl shadow-sm border border-emerald-50">
                                    <span className="font-black text-2xl">{i+1}. {c.name}</span>
                                    <div className="flex gap-4 items-center">
                                        <span className="text-zinc-400 font-bold">{c.phone}</span>
                                        <button onClick={() => deleteItem("customers", c.id)} className="text-red-400 font-black">XÓA</button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* 2. QUẢN LÝ ĐƠN HÀNG (Hồng Nhạt) */}
                    <div className="bento-box bg-[#fce4ec]">
                        <h2 className="huge-title text-[#ad1457]">Đơn Hàng</h2>
                        <div className="flex-1 overflow-auto space-y-4">
                            {deliveries.filter(d => !d.collected).map(d => (
                                <div key={d.id} className="bg-white p-8 rounded-[2.5rem] flex justify-between items-center shadow-sm">
                                    <div>
                                        <p className="font-black text-3xl mb-1">{d.customerName}</p>
                                        <p className="text-pink-400 font-bold uppercase tracking-widest text-sm">Hẹn Giao: {d.deliveryDate || 'Hôm nay'}</p>
                                    </div>
                                    <div className="text-right">
                                        <p className="text-5xl font-black text-pink-600 leading-none mb-2">{d.quantity}B</p>
                                        <button onClick={() => deleteItem("deliveries", d.id)} className="text-xs font-bold text-zinc-300 uppercase">Xóa Đơn</button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* 3. CÔNG NỢ (Vàng Nhạt) */}
                    <div className="bento-box bg-[#fff9db]">
                        <h2 className="huge-title text-[#f08c00]">Công Nợ</h2>
                        <div className="flex-1 overflow-auto space-y-4 pr-2">
                            {deliveries.filter(d => !d.collected).map(d => (
                                <div key={d.id} className="bg-white p-8 rounded-[2.5rem] border-4 border-yellow-200 flex justify-between items-center">
                                    <div>
                                        <p className="font-black text-3xl mb-1">{d.customerName}</p>
                                        <p className="text-xl text-yellow-600 font-bold uppercase italic">Nợ {d.quantity} Vỏ Bình</p>
                                    </div>
                                    <button onClick={() => markAsCollected(d.id)} className="bg-[#f08c00] text-white px-8 py-4 rounded-3xl font-black text-lg shadow-md">ĐÃ THU ✓</button>
                                </div>
                            ))}
                            {deliveries.filter(d => d.collected).map(d => (
                                <div key={d.id} className="bg-zinc-100/50 p-6 rounded-3xl opacity-40 flex justify-between items-center italic">
                                    <p className="font-bold text-2xl">{d.customerName} (Đã xong)</p>
                                    <span className="text-green-500 text-2xl font-black">✓</span>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* 4. TỔNG HỢP (Xanh Dương Nhạt) */}
                    <div className="bento-box bg-[#e7f5ff]">
                        <h2 className="huge-title text-[#1971c2]">Báo Cáo</h2>
                        <input className="input-field !bg-white border-4 border-blue-100 mb-8 !text-2xl h-20 px-8" placeholder="TÌM TÊN KHÁCH HÀNG..." onChange={e => setSearch(e.target.value)} />
                        
                        <div className="grid grid-cols-2 gap-6 flex-1">
                            <div className="bg-white p-10 rounded-[3rem] flex flex-col justify-center items-center shadow-sm border-b-8 border-blue-200">
                                <p className="text-sm font-black text-blue-400 uppercase tracking-[0.2em] mb-4">Tổng nợ bình</p>
                                <p className="text-8xl font-black text-blue-600 leading-none tracking-tighter">{totalDebtShells}</p>
                            </div>
                            <div className="bg-white p-10 rounded-[3rem] flex flex-col justify-center items-center shadow-sm border-b-8 border-orange-200">
                                <p className="text-sm font-black text-orange-300 uppercase tracking-[0.2em] mb-4">Tổng nợ tiền</p>
                                <p className="text-4xl font-black text-orange-500 tracking-tighter">{totalDebtCash.toLocaleString()}đ</p>
                            </div>
                            <div className="col-span-2 bg-zinc-900 rounded-[3rem] p-8 text-white flex justify-between items-center">
                                <div>
                                    <p className="text-xs font-bold text-zinc-500 uppercase tracking-widest mb-2 italic">Kết quả tìm kiếm cho: {search || 'Hệ thống'}</p>
                                    <p className="text-3xl font-black leading-none uppercase tracking-tighter">{deliveries.filter(d => d.customerName?.toLowerCase().includes(search.toLowerCase())).length} Đơn hàng phát sinh</p>
                                </div>
                                <div className="text-right">
                                    <p className="text-xs font-bold text-zinc-500 uppercase italic mb-1">Trạng thái</p>
                                    <p className="text-2xl font-black text-blue-400">ỔN ĐỊNH</p>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
