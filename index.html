<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Giviso Water - Quản Lý Toàn Diện</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, addDoc, deleteDoc, updateDoc, doc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "YOUR_API_KEY", // Dán mã của bạn vào đây
            projectId: "YOUR_PROJECT_ID"
        };
        const app = initializeApp(firebaseConfig);
        window.db = getFirestore(app);
        window.fs = { collection, onSnapshot, addDoc, deleteDoc, updateDoc, doc, query, orderBy, serverTimestamp };
    </script>
    <style>
        body { font-family: 'Quicksand', sans-serif; background-color: #f8fafc; color: #334155; }
        .bento-card { @apply bg-white rounded-[2.5rem] p-8 shadow-sm border border-slate-100 flex flex-col h-full transition-all hover:shadow-md; }
        .title-large { @apply text-3xl font-bold tracking-tight mb-6; }
        .input-soft { @apply bg-slate-50 border-none rounded-2xl px-4 py-3 mb-2 w-full focus:ring-2 focus:ring-blue-200 outline-none text-sm; }
        .btn-main { @apply bg-slate-900 text-white px-6 py-3 rounded-2xl font-bold text-sm hover:opacity-90 active:scale-95 transition-all; }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { @apply bg-slate-200 rounded-full; }
    </style>
</head>
<body class="p-4 md:p-10">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const App = () => {
            const [customers, setCustomers] = useState([]);
            const [deliveries, setDeliveries] = useState([]);
            const [search, setSearch] = useState("");
            const [newCust, setNewCust] = useState({ name: '', phone: '', address: '' });

            useEffect(() => {
                const { collection, onSnapshot, query, orderBy } = window.fs;
                // Lắng nghe Khách hàng
                onSnapshot(query(collection(window.db, "customers"), orderBy("name")), (sn) => 
                    setCustomers(sn.docs.map(d => ({id: d.id, ...d.data()}))));
                // Lắng nghe Đơn hàng/Nợ
                onSnapshot(query(collection(window.db, "deliveries"), orderBy("timestamp", "desc")), (sn) => 
                    setDeliveries(sn.docs.map(d => ({id: d.id, ...d.data()}))));
            }, []);

            // Logic: Thêm khách hàng
            const addCustomer = async () => {
                if(!newCust.name) return;
                await window.fs.addDoc(window.fs.collection(window.db, "customers"), newCust);
                setNewCust({ name: '', phone: '', address: '' });
            };

            // Logic: Thu nợ
            const markAsCollected = async (id) => {
                const docRef = window.fs.doc(window.db, "deliveries", id);
                await window.fs.updateDoc(docRef, { status: 'completed', collected: true });
            };

            // Logic: Xóa
            const deleteItem = async (col, id) => {
                if(confirm("Xác nhận xóa?")) await window.fs.deleteDoc(window.fs.doc(window.db, col, id));
            };

            const filteredData = deliveries.filter(d => d.customerName?.toLowerCase().includes(search.toLowerCase()));
            const totalDebtShells = deliveries.reduce((s, d) => s + (!d.collected ? (Number(d.quantity) || 0) : 0), 0);
            const totalDebtCash = totalDebtShells * 50000;

            return (
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 max-w-7xl mx-auto">
                    
                    {/* 1. QUẢN LÝ KHÁCH HÀNG (Màu Mint) */}
                    <div className="bento-card bg-[#f0fff4]">
                        <h2 className="title-large text-emerald-800">Khách Hàng</h2>
                        <div className="mb-4 bg-white/50 p-4 rounded-3xl">
                            <input className="input-soft" placeholder="Tên khách hàng..." value={newCust.name} onChange={e => setNewCust({...newCust, name: e.target.value})} />
                            <div className="flex gap-2">
                                <input className="input-soft" placeholder="SĐT" value={newCust.phone} onChange={e => setNewCust({...newCust, phone: e.target.value})} />
                                <input className="input-soft" placeholder="Địa chỉ" value={newCust.address} onChange={e => setNewCust({...newCust, address: e.target.value})} />
                            </div>
                            <button onClick={addCustomer} className="btn-main bg-emerald-600 w-full">Thêm khách mới</button>
                        </div>
                        <div className="flex-1 overflow-auto space-y-2">
                            {customers.map((c, i) => (
                                <div key={c.id} className="flex justify-between items-center p-4 bg-white rounded-2xl border border-emerald-100">
                                    <span className="font-bold text-lg">{i+1}. {c.name}</span>
                                    <button onClick={() => deleteItem("customers", c.id)} className="text-red-400 text-xs font-bold uppercase">Xóa</button>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* 2. QUẢN LÝ ĐƠN HÀNG (Màu Lavender) */}
                    <div className="bento-card bg-[#f5f3ff]">
                        <h2 className="title-large text-purple-800">Đơn Hàng</h2>
                        <div className="space-y-3 overflow-auto">
                            {deliveries.filter(d => d.status !== 'completed').map(d => (
                                <div key={d.id} className="bg-white p-5 rounded-3xl flex justify-between items-center shadow-sm">
                                    <div>
                                        <p className="font-bold text-xl">{d.customerName}</p>
                                        <p className="text-xs text-purple-400 font-bold uppercase">Hẹn: {d.deliveryDate || 'Hôm nay'}</p>
                                    </div>
                                    <div className="text-right">
                                        <p className="text-2xl font-black text-purple-600">{d.quantity}B</p>
                                        <button onClick={() => deleteItem("deliveries", d.id)} className="text-[10px] font-bold text-slate-300">XÓA</button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* 3. CÔNG NỢ (Màu Peach) */}
                    <div className="bento-card bg-[#fffaf3]">
                        <h2 className="title-large text-orange-800">Công Nợ</h2>
                        <div className="flex-1 overflow-auto space-y-3">
                            {deliveries.filter(d => !d.collected).map(d => (
                                <div key={d.id} className="bg-white p-5 rounded-3xl border-2 border-orange-100 flex justify-between items-center">
                                    <div>
                                        <p className="font-bold text-lg">{d.customerName}</p>
                                        <p className="text-sm text-orange-500 font-bold">Nợ {d.quantity} bình</p>
                                    </div>
                                    <button onClick={() => markAsCollected(d.id)} className="bg-orange-500 text-white px-4 py-2 rounded-xl text-xs font-bold">THU TIỀN</button>
                                </div>
                            ))}
                            {deliveries.filter(d => d.collected).map(d => (
                                <div key={d.id} className="bg-slate-50 p-4 rounded-2xl opacity-50 flex justify-between items-center grayscale">
                                    <p className="font-bold text-slate-400">{d.customerName} (Đã thu)</p>
                                    <span className="text-green-500 text-sm font-bold">✓</span>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* 4. BÁO CÁO TỔNG HỢP (Màu Sky) */}
                    <div className="bento-card bg-[#f0f9ff]">
                        <h2 className="title-large text-sky-800">Báo Cáo Thông Minh</h2>
                        <input className="input-soft !bg-white border-2 border-sky-100 mb-6" placeholder="Tìm tên khách hàng để xem công nợ..." onChange={e => setSearch(e.target.value)} />
                        
                        <div className="grid grid-cols-2 gap-4 flex-1">
                            <div className="bg-white p-6 rounded-[2rem] flex flex-col justify-center items-center text-center">
                                <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Tổng nợ bình</p>
                                <p className="text-5xl font-black text-sky-600 leading-none">{totalDebtShells}</p>
                            </div>
                            <div className="bg-white p-6 rounded-[2rem] flex flex-col justify-center items-center text-center">
                                <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-2">Tổng nợ tiền</p>
                                <p className="text-3xl font-black text-orange-600">{totalDebtCash.toLocaleString()}đ</p>
                            </div>
                            <div className="col-span-2 bg-slate-900 rounded-[2rem] p-6 text-white">
                                <p className="text-xs font-bold opacity-50 uppercase mb-4 tracking-widest">Phân tích nhanh cho {search || 'hệ thống'}</p>
                                <div className="space-y-1">
                                    <p className="text-xl font-bold italic">Sản lượng: {filteredData.length} đơn</p>
                                    <p className="text-xl font-bold italic">Trạng thái: {totalDebtShells > 20 ? 'Cảnh báo nợ cao' : 'Ổn định'}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
